



@page "/PG_PathogenGenePage"
@page "/PG_PathogenGenePage/{Text}/{Name?}"




<div class="divtop d-flex  align-items-center">

    <div class="  w-100 ">
        <Card>
            <CardHeader>
                查询条件
            </CardHeader>
            <CardBody>
                <Row RowType="RowType.Normal" ItemsPerRow="ItemsPerRow.Two">

                    <Search IgnoreCase="true" IsLikeMatch="true" @bind-Value="@Querywhere" placeholder="请输入关键信息..." OnSearch="@(s=>OnSearch())"></Search>

                    <button class="createbut fa fa-plus " @onclick="@(()=>OnShowDlg(null))"></button>
                </Row>
            </CardBody>
        </Card>

    </div>
</div>

<div class="w-100">
    <Card>
        <CardHeader>
            查询结果
        </CardHeader>
        <CardBody>
            <Table TItem="MedicalPG_PathogenGene" ShowLoading="true" IsPagination="true" IsStriped="true" IsBordered="true"
                   ShowToolbar="true" ShowAddButton="false" ShowEditButton="false" ShowDeleteButton="false"
                   OnQueryAsync="@OnQueryAsync" IsAutoRefresh="true" ShowCardView ="true"  FixedExtendButtonsColumn="true"
                   ShowExtendButtons="true" ShowColumnList="true" AutoGenerateColumns="true">
               <RowButtonTemplate>
                    <Button Size="Size.ExtraSmall" Color="Color.Info" Icon="fa fa-info" Text=" 详情 "  OnClick="@(()=>OnDetails(context))" ></Button>
                    <Button Size="Size.ExtraSmall" Color="Color.Info" Icon="fa fa-edit" Text=" 修改 "  OnClick="@(()=>OnEdit(context))" ></Button>
                    <PopConfirmButton Size="Size.ExtraSmall" ConfirmButtonColor="Color.Danger" Icon="fa fa-trash" OnConfirm="@(()=>OnDelete(context))" Placement="Placement.Top" Color="Color.Danger" ConfirmIcon="fa fa-exclamation-triangle text-danger"  Text="删除" Content="确定删除数据吗？" />
            </RowButtonTemplate>
            </Table>
        </CardBody>
    </Card>

</div>
<Message @ref="MessageElement" />



@code {

    [Inject]
    private MessageService messageService { set; get; }

    private Message MessageElement { set; get; }

    [Inject]
    DialogService? dialogService { set; get; }

    [Inject]
    IDbContextFactory<MedicalDbContext> contextFactory { set; get; }

    [CascadingParameter]
    Task<AuthenticationState> authenticationStateTask { set; get; }

    private string Querywhere { set; get; }

    private bool IsBackdropOpen { set; get; }

    private MedicalPG_PathogenGene pG_PathogenGene { set; get; } = new();
    private List<MedicalPG_PathogenGene> pG_PathogenGenes { set; get; } = new();



    [Parameter]
    public string Text { get; set; }

    [Parameter]
    public string Name { get; set; }
    protected override async Task OnParametersSetAsync()
    {
        if (Text is not null or "")
        {
            // Task.Run(()=> { ); });
            var obj = new MedicalPG_PathogenGene();
            obj.Medicalrecordnumber = Text;
            obj.Username = Name;
            await OnShowDlg(obj);
        }
        return;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await OnSearch();
        }
        return;//base.OnAfterRenderAsync(firstRender);
    }


    private async Task OnSearch()
    {


        using (var context = contextFactory.CreateDbContext())
        {
            var Adminname = authenticationStateTask.Result.User.Identity.Name;
            if (Querywhere is not null)
            {
                pG_PathogenGenes = await context.MPG_PathogenGenes.AsNoTracking().Where(w => w.Medicalrecordnumber.Contains(Querywhere) || w.Username.Contains(Querywhere)).ToListAsync();

            }
            else
            {
                pG_PathogenGenes = await context.MPG_PathogenGenes.AsNoTracking().Where(w => w.Adminname == Adminname).Take(100).ToListAsync();
            }
        }
        StateHasChanged();
        return; //Task.CompletedTask;
    }

    private Task<QueryData<MedicalPG_PathogenGene>> OnQueryAsync(QueryPageOptions options)
    {
        // 内存分页
        var items = pG_PathogenGenes.Skip((options.PageIndex - 1) * options.PageItems).Take(options.PageItems).ToList();

        return Task.FromResult(new QueryData<MedicalPG_PathogenGene>()
        {
            Items = items,
            TotalCount = pG_PathogenGenes.Count
            // IsSearch = true
        });
    }

    private async Task OnShowDlg(MedicalPG_PathogenGene obj)
    {

        var result = await dialogService.ShowModal<PG_PathogenGene_Dlg>(new ResultDialogOption()
        {
            Title = "新建病原菌基因",
            BodyContext = obj,
            Size = Size.ExtraSmall,
            ComponentParamters = new Dictionary<string, object>
            {
                //new(nameof(EditReportCard.TemplateParameter), Certificatetemplate),
                     [nameof(PG_PathogenGene_Dlg.OnEventCallback)]= EventCallback.Factory.Create<MedicalPG_PathogenGene>(this, v => pG_PathogenGene = v)
                }
        });

        if (result == DialogResult.Yes)
        {
            using (var context = contextFactory.CreateDbContext())
            {
                if (pG_PathogenGene != null)
                {
                    pG_PathogenGene.Createtime = DateTime.Now;
                    pG_PathogenGene.Adminname = authenticationStateTask.Result.User.Identity.Name;
                    context.MPG_PathogenGenes.Add(pG_PathogenGene);
                    context.SaveChanges();
                    pG_PathogenGenes.Add(pG_PathogenGene);
                    ShowColorMessage(Color.Success, "新建临床微生物学检查", MessageElement);
                }
            }
            // MessageTagservice.ShowColorMessage(Color.Danger, "医患信息添加成功", MessageElement);
        }
        return;
    }
        private async Task OnEdit(MedicalPG_PathogenGene myobject)
    {

        MedicalPG_PathogenGene  medicalPG = new MedicalPG_PathogenGene();
        var retdlg = await dialogService.ShowModal<PG_PathogenGene_Dlg>(new ResultDialogOption()
            {
                BodyContext = myobject,
                Title = "编辑修改",
                Size = Size.ExtraSmall,
                ComponentParamters = new Dictionary<string, object>
                {
                    [nameof(PG_PathogenGene_Dlg.OnEventCallback)] = EventCallback.Factory.Create<MedicalPG_PathogenGene>(this, v => medicalPG = v)
                }
            });

        if (retdlg == DialogResult.Yes)
        {
            try
            {
                using (var context = contextFactory.CreateDbContext())
                {
                    context.Update(medicalPG);
                    context.SaveChanges();
                    ShowColorMessage(Color.Success, "数据编辑修改成功", MessageElement);
                    Log.Information<MedicalPG_PathogenGene>(medicalPG.ToString()+"-----成功修改------",medicalPG);
                }
            }
            catch(Exception sqlex)
            {
                ShowColorMessage(Color.Warning, "数据编辑修改失败，请联系管理员", MessageElement);
                Log.Warning(sqlex.Message);
            }
        }
        StateHasChanged();
    }

    private async Task OnDelete(MedicalPG_PathogenGene myobject)
    {
        using (var context = contextFactory.CreateDbContext())
        {
            context.MPG_PathogenGenes.Remove(myobject);
            var ok = context.SaveChanges();
            if (ok > 0)
            {
                pG_PathogenGenes.Remove(myobject);
                ShowColorMessage(Color.Info, "注意：数据已经成功删除", MessageElement);
                StateHasChanged();
            }
            else
            {
                ShowColorMessage(Color.Warning, "数据删除失败", MessageElement);

            }
        }

    }
    private async Task OnDetails(MedicalPG_PathogenGene myobject)
    {
        pG_PathogenGene = myobject;
        StateHasChanged();
        IsBackdropOpen = IsBackdropOpen? false : true;
    }
    private Task OnRowEditClick()
    {
        return Task.CompletedTask;
    }
    public void ShowColorMessage(Color color, string content, Message message)
    {
         message.SetPlacement(Placement.Top);
            messageService?.Show(new MessageOption()
            {
             
                Content = content,
                Icon = "fa fa-info-circle",
                Color = color,
                ShowBar = true,
                ShowDismiss = true,
            }, message);
    }
    [Inject]
    private SwalService? SwalService { get; set; }

    private async Task Ondel(MedicalPG_PathogenGene myobject)
    {
        var op = new SwalOption()
        {
            Title = "警告",
            Content = "数据删除不可再恢复，是否确定删除？",
            IsConfirm = true,
            Category = SwalCategory.Warning
        };
        var re = await SwalService.ShowModal(op);
        if (re)
        {

            using (var context = contextFactory.CreateDbContext())
            {
                context.MPG_PathogenGenes.Remove(myobject);
                var ok = context.SaveChanges();
                if (ok > 0)
                {
                    pG_PathogenGenes.Remove(myobject);
                    StateHasChanged();
                }
                else
                {
                    ShowColorMessage(Color.Warning, "数据删除失败", MessageElement);

                }
            }
        }
        return;
    }
}

@*<h3>MedicalPGPage</h3>*@

