
@page "/clinicalmicrobiology"

@attribute [Authorize]
<PageTitle>临床微生物检查</PageTitle>

<BannerTitle Title="临床微生物检查"></BannerTitle>

<MudPaper Elevation="0" Class="mt-5 mb-1">
   <MudFab  Label="新建单据" Size="Size.Medium" Color="Color.Primary" DisableElevation="true"   OnClick="@OnOpenDialog" Class="mx-3" StartIcon="@Icons.Material.Outlined.AddCard" > </MudFab>

</MudPaper>

@if(MedicalPD_Microbiologicals is null){
    <MudCard>
    <MudCardHeader>
        <CardHeaderAvatar>
            <MudSkeleton SkeletonType="SkeletonType.Circle" Animation="Animation.Wave" Height="40px" Width="40px"/>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudSkeleton Animation="Animation.Wave" Width="40%" />
            <MudSkeleton Animation="Animation.Wave" Width="60%" />
        </CardHeaderContent>
    </MudCardHeader>
    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Animation="Animation.Wave" Height="250px" />
    <MudCardContent>
        <MudSkeleton Animation="Animation.Wave" />
    </MudCardContent>
    <MudCardActions>
    
        <MudSkeleton SkeletonType="SkeletonType.Circle" Animation="Animation.Wave" Height="30px" Width="30px" Class="ml-2 mb-2" />
        <MudSkeleton SkeletonType="SkeletonType.Circle" Animation="Animation.Wave" Height="30px" Width="30px" Class="ml-3 mb-2" />
    </MudCardActions>
</MudCard>
}
else{

    <MudTable T="MedicalPD_Microbiological" FixedFooter="true" FixedHeader = "true" Height="600px" Elevation="0" Items="@MedicalPD_Microbiologicals"  Hover="true" ReadOnly="true"
              Filter="new Func<MedicalPD_Microbiological,bool>(FilterFuncTable)"  Dense="true" >
        <ToolBarContent>
           
               <MudDateRangePicker   @ref="@rangePicker" @bind-DateRange="@daterange" Label="时间范围"  >
                <PickerActions>
                    <MudButton Class="mr-auto align-self-start "  OnClick="@(()=>rangePicker.Clear())" >清空选择数据</MudButton>
                    <MudButton OnClick="@(()=>rangePicker.Close(false))"> 关闭 </MudButton>
                    <MudButton OnClick="@(()=>PickerOK())" Color="Color.Primary"> 确定</MudButton>
                </PickerActions>
            </MudDateRangePicker>
          @*  <MudFab Size="Size.Small" DisableElevation="true" OnClick="@Refresh" Color="Color.Tertiary" StartIcon="@Icons.Filled.Refresh"></MudFab>*@
            <MudSpacer/><MudSpacer/><MudSpacer/><MudSpacer/>
      
            <MudTextField @bind-Value="searchPatientInfo" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh><b>编号</b></MudTh>
            <MudTh><b>姓名</b></MudTh>
            <MudTh><b>是否做检查</b></MudTh>
            <MudTh><b>检测日期</b></MudTh>
            <MudTh><b>标本类型</b></MudTh>
            <MudTh><b>是否检出</b></MudTh>
            <MudTh><b>报告时间</b></MudTh>
            <MudTh><b>报告日期</b></MudTh>
            <MudTh><b>检出细菌</b></MudTh>
            <MudTh><b>操作</b></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd >@context.Medicalrecordnumber</MudTd>
            <MudTd >@context.Username</MudTd>
            <MudTd >@context.TestorisNot</MudTd>
            <MudTd >@context.TestTime</MudTd>
            <MudTd >@context.SpecimenType</MudTd>
            <MudTd >@context.TestorNot</MudTd>
            <MudTd >@context.ReportTime</MudTd>
            <MudTd >@context.Inspectiontime</MudTd>
            <MudTd >@context.Bacterial</MudTd>
                          
            <MudTd >
                <MudTooltip Text="编辑档案">
                    <MudIconButton  OnClick="@(s=>OnEditPatientInfo(context))"  Color="Color.Info" Size="Size.Small" Icon="@Icons.Outlined.ModeEdit" Variant="Variant.Text" >  </MudIconButton>
                </MudTooltip>
                <MudTooltip Text="删除数据">
                        <MudIconButton Class="mx-3" Color="Color.Error"  Size="Size.Small" Icon="@Icons.Outlined.DeleteSweep" Variant="Variant.Text" >   </MudIconButton>
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager RowsPerPageString="当前页显示行数:" PageSizeOptions="new int[]{10,20,30,50, 100}" />
        </PagerContent>
    </MudTable>

}



@code{

    [Inject]
    protected ILogger<Index> Logger{ set; get; }

    [Inject]
     private DbServerProvider DbServerProvider { set; get; }
    [Inject] 
    protected IDialogService DialogService  { get; set; }

    private string  searchPatientInfo{set;get;}
    private bool resetValueOnEmptyText;
    private bool Loading { set; get; } = true;
    private bool coerceValue;
    private MedicalPD_Microbiological value1, value2;

    List<MedicalPD_Microbiological>   MedicalPD_Microbiologicals{ set; get; }

        /// <summary>
    /// 默认查询的时间范围(1个月时间)
    ///  DateTime dateTime = DateRangeValue.End.AddDays(1).AddMilliseconds(-1);
    ///  ListCertificates = _DbContext.TableCertificates.Where(w => w.CreateTime >= DateRangeValue.Start && w.CreateTime <= dateTime).ToList();
    /// </summary>
    DateRange daterange = new DateRange(DateTime.Now.Date.AddDays(-(DateTime.Now.Date.Day-1)), DateTime.Now.Date);
    private MudDateRangePicker rangePicker{ set; get; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            //Loading = true;
            
             MedicalPD_Microbiologicals = await DbServerProvider.GetListAsync<MedicalPD_Microbiological>();
            //MedicalPD_Microbiologicals = await  context.MPD_Microbiologicals
            //                                    .AsNoTracking()
            //                                    //.Where(w=>w.CreateTime>=daterange.Start.Value.Date&&w.CreateTime<=daterange.End.Value.Date.AddDays(1))
            //                                    .OrderByDescending(o => o.CreateTime)
            //                                    .Take(100)
            //                                    .ToListAsync();

           // Loading = false;
            StateHasChanged();
        }
        //  return base.OnAfterRenderAsync(firstRender);
    }

        /// <summary>
    /// 选择时间对话框确认选择
    /// </summary>
    /// <returns></returns>
    private async Task  PickerOK(){

        rangePicker.Close();

        if (MedicalPD_Microbiologicals is not null) MedicalPD_Microbiologicals.Clear();
        //if (Certificates is not null) Certificates.Clear();

         MedicalPD_Microbiologicals = await DbServerProvider.GetListAsync<MedicalPD_Microbiological>(daterange);

        //MedicalPD_Microbiologicals = await  context.MPD_Microbiologicals
        //                                        .AsNoTracking()
        //                                        .Where(w=>w.CreateTime>=daterange.Start.Value.Date&&w.CreateTime<=daterange.End.Value.Date.AddDays(1))
        //                                        .OrderByDescending(o => o.CreateTime)
        //                                        .ToListAsync();
        StateHasChanged();

        return;
    }

    private async Task<IEnumerable<MedicalPD_Microbiological>> Search(string value)
    {
        if (string.IsNullOrEmpty(value))
            return MedicalPD_Microbiologicals;
        return MedicalPD_Microbiologicals.Where(x => x.Username.Contains(value)|| x.Medicalrecordnumber.Contains(value));
    }

    private async Task OnOpenDialog()
    {
        DialogOptions dialogOptions = new DialogOptions();
        dialogOptions.CloseButton = true;
        dialogOptions.MaxWidth = MaxWidth.Small; 
        dialogOptions.FullWidth = true;
        dialogOptions.DisableBackdropClick = true;
        //var parameters = new DialogParameters();
        //parameters.Add("TemplateData",SelectTemplate);
        var dialog = DialogService.Show<DialogClinicalMicrobiology>("99",dialogOptions);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var p = result.Data as MedicalPD_Microbiological;
            MedicalPD_Microbiologicals.Insert(0,p);
            return ;
        }
    }

    private async Task OnEditPatientInfo(MedicalPD_Microbiological  MedicalPD_Microbiological)
    {
        DialogOptions dialogOptions = new DialogOptions();
        dialogOptions.CloseButton = true;
        dialogOptions.MaxWidth = MaxWidth.Medium; 
        dialogOptions.FullWidth = true;
        dialogOptions.DisableBackdropClick = true;

        var parameters = new DialogParameters();
        parameters.Add("MedicalValue",MedicalPD_Microbiological);
        parameters.Add("IsEdit",true);

        var dialog = DialogService.Show<DialogClinicalMicrobiology>("99",parameters,dialogOptions);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            return ;
        }
    }


    /// <summary>
    /// 重新加载数据
    /// </summary>
    /// <returns></returns>
    private async Task Refresh()
    {
        await OnInitializedAsync();
        StateHasChanged();

        Logger.LogInformation("刷新数据成功");
        return;
    }

    /// <summary>
    /// 表格数据帅选过滤
    /// </summary>
    /// <param name="element"></param>
    /// <returns></returns>
    private bool FilterFuncTable(MedicalPD_Microbiological element) => FilterFunc(element, searchPatientInfo);

    private bool FilterFunc(MedicalPD_Microbiological element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
            if($"{element.Medicalrecordnumber} {element.Username} {element.SpecimenType} {element.Bacterial}".Contains(searchString)){
             return true;
        }
        return false;
    }
}




